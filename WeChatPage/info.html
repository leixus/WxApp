<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no, email=no">
    <link rel="stylesheet" href="./css/default.css">
    <title></title>
</head>
<body>
<div class="main">
    <form style="width: 90%; margin: 0 auto; font-family: PingFangSC-Regular, sans-serif;">
        <ul>
            <li>
                <div class="input_name">
                    <label>姓：</label>
                    <input type="text" id="input_name1" placeholder="*" class="input_border">
                </div>
                <div class="input_name">
                    <label>名：</label>
                    <input type="text" id="input_name2" placeholder="*" class="input_border">
                </div>
            </li>
            <li>
                <div class="input_name" style="border-bottom: 1px solid #e4e3df;">
                    <label style="padding-bottom: 5px;">生日：</label>
                    <div class="select_year"><select id="sel_year"></select>年</div>
                    <div class="select_time"><select id="sel_month"></select>月</div>
                    <div class="select_time"><select id="sel_day"></select>日</div>
                </div>
                <div class="input_name">
                    <label style="padding-bottom: 5px;">性别：</label>
                    <div>
                        <div class="check_box">
                            <span class="check xingbie">
                                <input type="radio" name="gender" value="0">
                            </span>
                            <span>女士</span>
                        </div>
                        <div class="check_box">
                            <span class="check xingbie">
                                <input type="radio" name="gender" value="1">
                            </span>
                            <span>男士</span>
                        </div>
                    </div>
                </div>
            </li>
            <li>
                <div class="input_full">
                    <label>手机号：</label>
                    <input type="text" id="input_phone" placeholder="请输入您的手机号" class="input_border" maxlength="11">
                </div>
            </li>
            <li class="code">
                <div class="code_left">
                    <label>验证码：</label>
                    <input type="text" id="input_code" placeholder="请输入6位验证码" class="input_border" maxlength="6">
                </div>
                <input class="code_right" style="font-size: 15px;" id="obtain_code" type="button" value="获取验证码">
            </li>
            <li>
                <label>国籍：</label>
                <div class="country">
                    <div class="check_box">
                        <span class="check guojia">
                            <input type="radio" name="country" value="1">
                        </span>
                        <span>中国</span>
                    </div>
                    <div class="check_box">
                        <span class="check guojia">
                            <input type="radio" name="country" value="2">
                        </span>
                        <span>其他</span>
                    </div>
                </div>
                <input type="text" id="input_country" class="input_border country_input">
            </li>
            <li>
                <div class="input_full">
                    <label>邮箱地址：</label>
                    <input type="text" id="input_mail" placeholder="请输入您的邮箱地址" class="input_border">
                </div>
            </li>
            <li>
                <span class="check agree check_style" style="float: left;">
                    <!--<input type="checkbox" name="agree" value="1">-->
                </span>
                <p class="explain">同意以市场推广目的，包括个性化定制内容（通过信函、销售人员来电、电子邮件、传真、短彩信以及微信的形式），
                    以及每一家FENDI店铺的个性化数据处理。</p>
            </li>
            <li>
                <span class="check agree check_style" style="float: left;">
                    <!--<input type="checkbox" name="agree" value="2">-->
                </span>
                <p class="explain">同意创建个人档案，分析个人兴趣、喜好和购买习惯，同时参考在FENDI店铺购买产品的相关数据。</p>
            </li>
            <a class="privacy" href="./read.html">相关隐私条款</a>
        </ul>
    </form>

    <div class="footer btn_color1">
        <div id="submit_btn">Enjoy Martini</div>
        <img src="images/jb.png">
    </div>
</div>
<script src="js/jquery-1.8.3.min.js"></script>
<script src="js/birthday.js"></script>
<script src="js/url.js"></script>
<script>
    $(function () {
        /**日期选择器调用**/
        $.ms_DatePicker({
            YearSelector: ".sel_year",
            MonthSelector: ".sel_month",
            DaySelector: ".sel_day"
        })
        $.ms_DatePicker()
        /**性别**/
        $('input[name="gender"]').on('click',function () {
            $('.xingbie').removeClass('check_style')
            $(this).parent().addClass('check_style')
        })

        /**国籍**/
        $('input[name="country"]').on('click',function () {
            $('.guojia').removeClass('check_style')
            $(this).parent().addClass('check_style')
        })

        $('#submit_btn').on('click',function () {
            vaild()
        })

        /**隐私声明**/
        $('.agree').on('click',function () {
            if($(this).hasClass('check_style'))
            {
                $(this).removeClass('check_style')
            }
            else
            {
                $(this).addClass('check_style')
            }
            /**处理提交按钮交互方式**/
            if($('.agree.check_style').length == 2)
            {
                $('.footer').removeClass('btn_color2')
                $('.footer').addClass('btn_color1')
                $('#submit_btn').on('click',function () {
                    vaild()
                })
            }
            else
            {
                $('.footer').removeClass('btn_color1')
                $('.footer').addClass('btn_color2')
                $('#submit_btn').unbind()
            }
        })

        /**对提交信息进行校验**/
        function vaild() {
            var vaildData = {
                must: {
                    name1: {
                        value: $('#input_name1').val(),
                        test: /^[A-Za-z\u4e00-\u9fa5]+$/,
                        error: '请输入姓（中文或英文）'
                    },
                    name2: {
                        value: $('#input_name2').val(),
                        test: /^[A-Za-z\u4e00-\u9fa5]+$/,
                        error: '请输入名（中文或英文）'
                    },
                    gender: {
                        value: $('input[name="gender"]:checked').val(),
                        test: /^\S*$/,
                        error: '请选择性别'
                    },
                    phone: {
                        value: $('#input_phone').val(),
                        test: /^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\d{8}$/,
                        error: '请输入正确的手机号码'
                    },
                    code: {
                        value: $('#input_code').val(),
                        test: /^\d{6}$/,
                        error: '请输入6位验证码'
                    }
                },
                country: {
                    value: $('input[name="country"]:checked').val(),
                    test: /^[A-Za-z\u4e00-\u9fa5]+$/,
                    error: '请输入国籍（中文或英文）'
                },
                mail: {
                    value: $('#input_mail').val(),
                    test: /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/,
                    error: '请输入正确的邮箱'
                }
            }
            var subData = {}
            for(key in vaildData.must){
                if(vaildData.must[key].test.test(vaildData.must[key].value))
                {
                    subData[key] = vaildData.must[key].value
                }
                else
                {
                    alert(vaildData.must[key].error)
                    return false
                }
            }
            /**国籍**/
            if(vaildData.country.value == 1)
            {
                subData.country = '中国'
            }
            else
            {
                if(vaildData.country.test.test($('#input_country').val()))
                {
                    subData.country = $('#input_country').val()
                }
                else
                {
                    alert(vaildData.country.error)
                    return false
                }
            }
            /**邮箱**/
            if(vaildData.mail.value != '')
            {
                if(vaildData.mail.test.test(vaildData.mail.value))
                {
                    subData.mail = vaildData.mail.value
                }
                else
                {
                    alert(vaildData.mail.error)
                    return false
                }
            }
            else
            {
                subData.mail = ''
            }
            if($('#sel_year').val() != 0 && $('#sel_month').val() != 0 && $('#sel_day').val() != 0)
            {
                subData.date = $('#sel_year').val() + '-' + $('#sel_month').val() + '-' + $('#sel_day').val() + ' 00:00:00'
            }
            else
            {
                subData.date = ''
            }
            submit(subData)
        }

        /**提交信息ajax方法**/
        function submit(opt) {
            var args = parseUrl(window.location.href)
            $.ajax({
                type: "post",
                url: 'http://ecrm.fendi.cn:8084/API/Fendi//Regist',
                data: {
                    model: JSON.stringify({
                        openId: args.openId,
                        FirstName: opt.name1,
                        LastName: opt.name2,
                        Gender: opt.gender,
                        CellPhone: opt.phone,
                        CountryType: $('input[name="country"]:checked').val(),
                        Country: opt.country,
                        Email: opt.mail,
                        SecurityCode: opt.code,
                        Birthday: opt.date,
                        RegistType: args.RegistType
                    })
                },
                success: function(response) {
                    console.log(response)
                    if(response.Status == 'SUCCESS')
                    {
                        if(response.ContextData == true)
                        {
                            window.location.href = './lottery.html?openId=' + args.openId
                        }
                        else
                        {
                            alert('注册失败')
                        }
                    }
                    else if(response.Status == 'WARN'){
                        alert(response.Message)
                    }
                }
            })
        }
        
        $('#obtain_code').on('click',function () {
            var res = /^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\d{8}$/
            var phone = $('#input_phone').val()
            if(res.test(phone))
            {
                obtain(phone)
            }
            else
            {
                alert('请输入正确的手机号码')
            }
        })
        /**倒计时一分钟**/
        var wait = 60
        function countdown() {
            $('#obtain_code').css('background','#e5e4e0')
            if (wait == 0) {
                $('#obtain_code').css('background','#488157')
                $('#obtain_code').attr('disabled',false)
                $('#obtain_code').val('获取验证码')
                wait = 60
            } else {
                $('#obtain_code').attr('disabled',true)
                $('#obtain_code').val(wait + '后重新发送')
                wait--
                setTimeout(function() {
                    countdown()
                }, 1000)
            }
        }

        function obtain(data) {
            $.ajax({
                type: "post",
                url: 'http://ecrm.fendi.cn:8084/API/Fendi/SendSecurityCode',
                data: {
                    phone: data
                },
                success: function(response) {
                    if(response.Status == 'SUCCESS')
                    {
                        if(response.ContextData == true)
                        {
                            countdown()
                        }
                        else
                        {
                            alert('发送失败')
                        }
                    }
                    else if(response.Status == 'WARN'){
                        alert(response.Message)
                    }
                }
            })
        }
        function user() {
            var args = parseUrl(window.location.href)
            $.ajax({
                type: "post",
                url: 'http://ecrm.fendi.cn:8084/API/Fendi/GetDataByOpenId',
                data: {
                    openId: args.openId
                },
                success: function(response) {
                    if(response.Status == 'SUCCESS')
                    {
                        if(response.ContextData !== null)
                        {
                            if(response.ContextData.Status == 1)
                            {
                                $('#input_name1').val(response.ContextData.FirstName)
                                $('#input_name2').val(response.ContextData.LastName)
                                $('#input_phone').val(response.ContextData.CellPhone)
                                $('#input_mail').val(response.ContextData.Email)
                                /**性别**/
                                $('input[name="gender"][value=' + response.ContextData.Gender + ']').prop('checked','checked')
                                $('input[name="gender"]:checked').parent().addClass('check_style')
                                /**国籍**/
                                $('input[name="country"][value=' + response.ContextData.CountryType + ']').prop('checked','checked')
                                $('input[name="country"]:checked').parent().addClass('check_style')
                                if(response.ContextData.CountryType == 2){
                                    $('#input_country').val(response.ContextData.Country)
                                }
                                /**年月日**/
                                var birth = response.ContextData.Birthday.split(' ')[0].split('-')
                                $('#sel_year').val(birth[0])
                                $('#sel_month').val(birth[1])
                                setDay()
                                $('#sel_day').val(birth[2])
                            }
                        }
                        else
                        {
                            $('input[name="country"][value="1"]').prop('checked','checked')
                            $('input[name="country"]:checked').parent().addClass('check_style')
                        }
                    }
                    else if(response.Status == 'WARN'){
                        alert(response.Message)
                    }
                }
            })
        }
        user()
        function setDay() {
            var str = '<option value="0">-</option>'
            if ($('#sel_year').val() == 0 || $('#sel_month').val() == 0) {
                // 未选择年份或者月份
                $('#sel_day').html(str)
            } else {
                $('#sel_day').html(str)
                var year = parseInt($('#sel_year').val())
                var month = parseInt($('#sel_month').val())
                var dayCount = 0
                switch (month) {
                    case 1:
                    case 3:
                    case 5:
                    case 7:
                    case 8:
                    case 10:
                    case 12:
                        dayCount = 31
                        break
                    case 4:
                    case 6:
                    case 9:
                    case 11:
                        dayCount = 30
                        break
                    case 2:
                        dayCount = 28
                        if (year % 4 == 0) {
                            dayCount = 29
                        }
                        break
                    default:
                        break
                }

                var daySel = $('#sel_day').attr("rel")
                for (var i = 1; i <= dayCount; i++) {
                    var sed = daySel==i?"selected":""
                    if(i<10)
                    {
                        var dayStr = "<option value=\"0" + i + "\" "+sed+">0" + i + "</option>"
                    }
                    else
                    {
                        var dayStr = "<option value=\"" + i + "\" "+sed+">" + i + "</option>"
                    }
                    $('#sel_day').append(dayStr)
                }
            }
        }
    })
</script>
</body>
</html>